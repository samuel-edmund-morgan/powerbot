name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      run_migrate:
        description: "Run DB migrate (auto/true/false)"
        required: false
        default: "auto"

jobs:
  deploy_test:
    if: github.event_name == 'push'
    runs-on: self-hosted
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version
        run: echo "VERSION=$(date +%Y.%m.%d)-${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV

      - name: Ensure git
        run: |
          if command -v git >/dev/null 2>&1; then
            git --version
            exit 0
          fi
          if command -v apt-get >/dev/null 2>&1; then
            if command -v sudo >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y git
            else
              apt-get update
              apt-get install -y git
            fi
            git --version
            exit 0
          fi
          if command -v yum >/dev/null 2>&1; then
            if command -v sudo >/dev/null 2>&1; then
              sudo yum install -y git
            else
              yum install -y git
            fi
            git --version
            exit 0
          fi
          if command -v apk >/dev/null 2>&1; then
            if command -v sudo >/dev/null 2>&1; then
              sudo apk add --no-cache git
            else
              apk add --no-cache git
            fi
            git --version
            exit 0
          fi
          echo "git is required but was not found and no supported package manager is available"
          exit 1

      - name: Detect migration need
        run: |
          set -e
          CHANGED="$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || true)"
          if [[ -z "$CHANGED" ]]; then
            CHANGED="$(git show --name-only --pretty='' ${{ github.sha }})"
          fi
          if echo "$CHANGED" | grep -E -q '^(schema\.sql|migrate_db\.py)$'; then
            echo "MIGRATE=1" >> $GITHUB_ENV
          else
            echo "MIGRATE=0" >> $GITHUB_ENV
          fi

      - name: Deploy test
        env:
          DOCKERHUB_USER: semorgana
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: ./scripts/deploy_test.sh

  deploy_prod:
    if: github.event_name == 'workflow_dispatch'
    runs-on: self-hosted
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version
        run: echo "VERSION=$(date +%Y.%m.%d)-${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV

      - name: Ensure git
        run: |
          if command -v git >/dev/null 2>&1; then
            git --version
            exit 0
          fi
          if command -v apt-get >/dev/null 2>&1; then
            if command -v sudo >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y git
            else
              apt-get update
              apt-get install -y git
            fi
            git --version
            exit 0
          fi
          if command -v yum >/dev/null 2>&1; then
            if command -v sudo >/dev/null 2>&1; then
              sudo yum install -y git
            else
              yum install -y git
            fi
            git --version
            exit 0
          fi
          if command -v apk >/dev/null 2>&1; then
            if command -v sudo >/dev/null 2>&1; then
              sudo apk add --no-cache git
            else
              apk add --no-cache git
            fi
            git --version
            exit 0
          fi
          echo "git is required but was not found and no supported package manager is available"
          exit 1

      - name: Detect migration need
        run: |
          set -e
          if [[ "${{ inputs.run_migrate }}" == "true" ]]; then
            echo "MIGRATE=1" >> $GITHUB_ENV
            exit 0
          fi
          if [[ "${{ inputs.run_migrate }}" == "false" ]]; then
            echo "MIGRATE=0" >> $GITHUB_ENV
            exit 0
          fi
          CHANGED="$(git diff --name-only HEAD~1 HEAD 2>/dev/null || true)"
          if [[ -z "$CHANGED" ]]; then
            CHANGED="$(git show --name-only --pretty='' HEAD)"
          fi
          if echo "$CHANGED" | grep -E -q '^(schema\.sql|migrate_db\.py)$'; then
            echo "MIGRATE=1" >> $GITHUB_ENV
          else
            echo "MIGRATE=0" >> $GITHUB_ENV
          fi

      - name: Deploy prod
        env:
          DOCKERHUB_USER: semorgana
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: ./scripts/deploy_prod.sh
