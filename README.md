# üîå PowerBot

Telegram –±–æ—Ç –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –µ–ª–µ–∫—Ç—Ä–æ–ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è –∂–∏—Ç–ª–æ–≤–æ–≥–æ –∫–æ–º–ø–ª–µ–∫—Å—É –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é –∫—ñ–ª—å–∫–æ—Ö –±—É–¥–∏–Ω–∫—ñ–≤.

## ‚ú® –ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ

- üì° **–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –µ–ª–µ–∫—Ç—Ä–æ–ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –≤—ñ–¥–∫–ª—é—á–µ–Ω—å —á–µ—Ä–µ–∑ –ø—ñ–Ω–≥ –¥–∞—Ç—á–∏–∫—ñ–≤
- üè† **–ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –∫—ñ–ª—å–∫–æ—Ö –±—É–¥–∏–Ω–∫—ñ–≤** ‚Äî –∫–æ–∂–µ–Ω –±—É–¥–∏–Ω–æ–∫ –º–æ–∂–µ –º–∞—Ç–∏ —Å–≤—ñ–π –¥–∞—Ç—á–∏–∫
- üîî **Push-—Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è** ‚Äî –º–∏—Ç—Ç—î–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è/–≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–≤—ñ—Ç–ª–∞
- üö® **–ü–æ–≤—ñ—Ç—Ä—è–Ω—ñ —Ç—Ä–∏–≤–æ–≥–∏** ‚Äî —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ —Ç—Ä–∏–≤–æ–≥–∏ —á–µ—Ä–µ–∑ ukrainealarm.com API
- üå°Ô∏è **–ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è** ‚Äî –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–æ –≤–æ–¥—É/–æ–ø–∞–ª–µ–Ω–Ω—è —Å–µ—Ä–µ–¥ –º–µ—à–∫–∞–Ω—Ü—ñ–≤
- üó∫Ô∏è **–î–æ–≤—ñ–¥–Ω–∏–∫** ‚Äî –∫–æ—Ä–∏—Å–Ω—ñ –º—ñ—Å—Ü—è –ø–æ–±–ª–∏–∑—É (–∫–∞—Ñ–µ, –º–∞–≥–∞–∑–∏–Ω–∏, –∞–ø—Ç–µ–∫–∏)
- üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** ‚Äî —ñ—Å—Ç–æ—Ä—ñ—è –≤—ñ–¥–∫–ª—é—á–µ–Ω—å —Ç–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞
- üå§Ô∏è **–ü–æ–≥–æ–¥–∞** ‚Äî –∞–∫—Ç—É–∞–ª—å–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥–∏

## üèóÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—î–∫—Ç—É

```
/home/powerbot/powerbot/
‚îú‚îÄ‚îÄ prod/                   # Production —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ
‚îÇ   ‚îú‚îÄ‚îÄ main.py            # –¢–æ—á–∫–∞ –≤—Ö–æ–¥—É
‚îÇ   ‚îú‚îÄ‚îÄ config.py          # –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –∑ .env
‚îÇ   ‚îú‚îÄ‚îÄ database.py        # –†–æ–±–æ—Ç–∞ –∑ SQLite
‚îÇ   ‚îú‚îÄ‚îÄ handlers.py        # –û–±—Ä–æ–±–Ω–∏–∫–∏ Telegram –∫–æ–º–∞–Ω–¥
‚îÇ   ‚îú‚îÄ‚îÄ services.py        # –ë—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ weather.py         # API –ø–æ–≥–æ–¥–∏
‚îÇ   ‚îú‚îÄ‚îÄ alerts.py          # API —Ç—Ä–∏–≤–æ–≥
‚îÇ   ‚îú‚îÄ‚îÄ maps/              # –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–∞—Ä—Ç
‚îÇ   ‚îú‚îÄ‚îÄ .env               # –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è (–Ω–µ –≤ Git!)
‚îÇ   ‚îî‚îÄ‚îÄ state.db           # –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö (–Ω–µ –≤ Git!)
‚îÇ
‚îú‚îÄ‚îÄ test/                   # Test —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ (–∞–Ω–∞–ª–æ–≥—ñ—á–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
‚îÇ
‚îú‚îÄ‚îÄ deploy_code.sh         # –î–µ–ø–ª–æ–π –∫–æ–¥—É test ‚Üí prod
‚îú‚îÄ‚îÄ migrate_db.py          # –ú—ñ–≥—Ä–∞—Ü—ñ—è –ë–î test ‚Üí prod
‚îú‚îÄ‚îÄ schema.sql             # –°—Ö–µ–º–∞ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
‚îú‚îÄ‚îÄ .env.example           # –®–∞–±–ª–æ–Ω –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
‚îú‚îÄ‚îÄ .gitignore             # –Ü–≥–Ω–æ—Ä–æ–≤–∞–Ω—ñ —Ñ–∞–π–ª–∏
‚îî‚îÄ‚îÄ README.md              # –¶–µ–π —Ñ–∞–π–ª
```

## üöÄ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è

### –í–∏–º–æ–≥–∏

- Ubuntu 22.04+ / Debian 12+
- Python 3.11+
- SQLite 3
- systemd

### –ö—Ä–æ–∫ 1: –ö–ª–æ–Ω—É–≤–∞–Ω–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é

```bash
# –°—Ç–≤–æ—Ä—ñ—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
sudo useradd -m -s /bin/bash powerbot
sudo su - powerbot

# –ö–ª–æ–Ω—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π
cd /home/powerbot
git clone https://github.com/samuel-edmund-morgan/powerbot.git
cd powerbot
```

### –ö—Ä–æ–∫ 2: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞

```bash
python3 -m venv .venv
source .venv/bin/activate
pip install --upgrade pip
pip install aiogram aiosqlite python-dotenv aiohttp
```

### –ö—Ä–æ–∫ 3: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–µ—Ä–µ–¥–æ–≤–∏—â

```bash
# –ö–æ–ø—ñ—é—î–º–æ —à–∞–±–ª–æ–Ω –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
cp .env.example prod/.env
cp .env.example test/.env

# –†–µ–¥–∞–≥—É—î–º–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é (–∑–∞–º—ñ–Ω—ñ—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è)
nano prod/.env
nano test/.env
```

### –ö—Ä–æ–∫ 4: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö

```bash
# –î–ª—è production
cd prod
sqlite3 state.db < ../schema.sql

# –î–ª—è test
cd ../test
sqlite3 state.db < ../schema.sql
```

### –ö—Ä–æ–∫ 5: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è systemd

–°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `/etc/systemd/system/bot-prod.service`:

```ini
[Unit]
Description=Telegram Power Bot - PRODUCTION
After=network.target

[Service]
Type=simple
User=powerbot
Group=powerbot
WorkingDirectory=/home/powerbot/powerbot/prod
ExecStart=/home/powerbot/powerbot/.venv/bin/python /home/powerbot/powerbot/prod/main.py
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

–ê–Ω–∞–ª–æ–≥—ñ—á–Ω–æ –¥–ª—è test (–∑–º—ñ–Ω—ñ—Ç—å `prod` –Ω–∞ `test` —Ç–∞ Description).

```bash
# –ê–∫—Ç–∏–≤—É—î–º–æ —Ç–∞ –∑–∞–ø—É—Å–∫–∞—î–º–æ
sudo systemctl daemon-reload
sudo systemctl enable bot-prod.service
sudo systemctl start bot-prod.service

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å
sudo systemctl status bot-prod.service
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è (.env)

```bash
# –†–µ–∂–∏–º —Ä–æ–±–æ—Ç–∏: "prod" –∞–±–æ "test"
BOT_MODE="prod"

# Telegram Bot Token –≤—ñ–¥ @BotFather
BOT_TOKEN="123456789:ABCdefGHIjklMNOpqrsTUVwxyz"

# Username –±–æ—Ç–∞ (–±–µ–∑ @)
BOT_USERNAME="YourBotUsername"

# ID –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤ (—á–µ—Ä–µ–∑ –∫–æ–º—É)
ADMIN_IDS="123456789,987654321"

# –¢–µ–≥ –∞–¥–º—ñ–Ω–∞ –¥–ª—è –∑–≤–æ—Ä–æ—Ç–Ω–æ–≥–æ –∑–≤'—è–∑–∫—É
ADMIN_TAG="@YourAdminUsername"

# IP –∞–¥—Ä–µ—Å–∏ –¥–∞—Ç—á–∏–∫—ñ–≤ –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É (—á–µ—Ä–µ–∑ –∫–æ–º—É)
HOME_IP="192.168.1.1,192.168.1.2"

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É
CHECK_INTERVAL_SEC="15"          # –Ü–Ω—Ç–µ—Ä–≤–∞–ª –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ (—Å–µ–∫)
FAILS_TO_DECLARE_DOWN="150"      # –ö—ñ–ª—å–∫—ñ—Å—Ç—å fail –¥–æ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è DOWN
SUCCESSES_TO_DECLARE_UP="1"      # –ö—ñ–ª—å–∫—ñ—Å—Ç—å success –¥–æ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è UP
TIMEOUT_SEC="1"                  # –¢–∞–π–º–∞—É—Ç –ø—ñ–Ω–≥—É (—Å–µ–∫)
DOWN_THRESHOLD="0.6"             # –ü–æ—Ä—ñ–≥ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ (0.0-1.0)
MIN_FAIL_HOSTS="10"              # –ú—ñ–Ω. –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏—Ö —Ö–æ—Å—Ç—ñ–≤

# –¢–µ–ª–µ—Ñ–æ–Ω–∏ —Å–µ—Ä–≤—ñ—Å–Ω–∏—Ö —Å–ª—É–∂–±
SECURITY_PHONE="+380XXXXXXXXX"
PLUMBER_PHONE="+380XXXXXXXXX"
ELECTRICIAN_PHONE="+380XXXXXXXXX"
ELEVATOR_PHONES="+380XXXXXXXXX"

# API –∫–ª—é—á –¥–ª—è —Ç—Ä–∏–≤–æ–≥ (https://api.ukrainealarm.com)
ALERTS_API_KEY="your_alerts_api_key_here"
```

## üì¶ –î–µ–ø–ª–æ–π

### –î–µ–ø–ª–æ–π –∫–æ–¥—É (test ‚Üí prod)

```bash
cd /home/powerbot/powerbot

# –ü–µ—Ä–µ–≥–ª—è–¥ –∑–º—ñ–Ω (dry run)
./deploy_code.sh --dry-run

# –í–∏–∫–æ–Ω–∞–Ω–Ω—è –¥–µ–ø–ª–æ—é
./deploy_code.sh

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
sudo systemctl restart bot-prod.service
```

### –ú—ñ–≥—Ä–∞—Ü—ñ—è –ë–î (test ‚Üí prod)

```bash
# –ó—É–ø–∏–Ω—è—î–º–æ –±–æ—Ç–∞
sudo systemctl stop bot-prod.service

# –ü–µ—Ä–µ–≥–ª—è–¥ –∑–º—ñ–Ω (dry run)
python migrate_db.py --dry-run

# –í–∏–∫–æ–Ω–∞–Ω–Ω—è –º—ñ–≥—Ä–∞—Ü—ñ—ó
python migrate_db.py

# –ó–∞–ø—É—Å–∫–∞—î–º–æ –±–æ—Ç–∞
sudo systemctl start bot-prod.service
```

## üîß –ö–æ—Ä–∏—Å–Ω—ñ –∫–æ–º–∞–Ω–¥–∏

```bash
# –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞
sudo systemctl status bot-prod.service

# –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ
sudo journalctl -u bot-prod.service -f

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
sudo systemctl restart bot-prod.service

# –†—É—á–Ω–∏–π –±–µ–∫–∞–ø –ë–î
./backup_db.sh prod    # –±–µ–∫–∞–ø production
./backup_db.sh test    # –±–µ–∫–∞–ø test
```

## üíæ –ë–µ–∫–∞–ø–∏

–ë–µ–∫–∞–ø–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ `/home/powerbot/powerbot/backups/`:

| –¢–∏–ø | –î–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è | –ö–æ–ª–∏ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è |
|-----|------------|------------------|
| –ö–æ–¥ | `backups/code/` | –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏ `./deploy_code.sh` |
| –ë–î | `backups/db/` | –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏ `python migrate_db.py` |
| –ë–î | `backups/db/` | –í—Ä—É—á–Ω—É –ø—Ä–∏ `./backup_db.sh` |

# –ó—É–ø–∏–Ω–∫–∞
sudo systemctl stop bot-prod.service
```

## üóÉÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö

–û—Å–Ω–æ–≤–Ω—ñ —Ç–∞–±–ª–∏—Ü—ñ:

| –¢–∞–±–ª–∏—Ü—è | –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è |
|---------|-------------|
| `subscribers` | –ü—ñ–¥–ø–∏—Å–Ω–∏–∫–∏ –±–æ—Ç–∞ |
| `buildings` | –ë—É–¥–∏–Ω–∫–∏ –∫–æ–º–ø–ª–µ–∫—Å—É |
| `events` | –Ü—Å—Ç–æ—Ä—ñ—è –ø–æ–¥—ñ–π (—Å–≤—ñ—Ç–ª–æ on/off) |
| `water_votes` | –ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è –∑–∞ –≤–æ–¥—É |
| `heating_votes` | –ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è –∑–∞ –æ–ø–∞–ª–µ–Ω–Ω—è |
| `places` | –î–æ–≤—ñ–¥–Ω–∏–∫ –∫–æ—Ä–∏—Å–Ω–∏—Ö –º—ñ—Å—Ü—å |
| `place_likes` | –õ–∞–π–∫–∏ –º—ñ—Å—Ü—å |

## üìù –õ—ñ—Ü–µ–Ω–∑—ñ—è

MIT License

## üë®‚Äçüíª –ê–≤—Ç–æ—Ä

–°—Ç–≤–æ—Ä–µ–Ω–æ –¥–ª—è –∂–∏—Ç–µ–ª—ñ–≤ –ñ–ö –∑ ‚ù§Ô∏è
