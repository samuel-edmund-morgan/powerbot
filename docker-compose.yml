services:
  powerbot:
    image: semorgana/powerbot:latest
    env_file:
      - ./.env
    environment:
      DB_PATH: /data/state.db
    volumes:
      # Mount the whole data dir so SQLite WAL/SHM live next to state.db
      # and are shared between services (powerbot/businessbot/migrate).
      - ./:/data
    ports:
      - "18081:8081"
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=${TRAEFIK_NETWORK}"
      - "traefik.http.routers.${TRAEFIK_ROUTER}.rule=${TRAEFIK_RULE}"
      - "traefik.http.routers.${TRAEFIK_ROUTER}.entrypoints=websecure"
      - "traefik.http.routers.${TRAEFIK_ROUTER}.tls=true"
      - "traefik.http.routers.${TRAEFIK_ROUTER}.tls.certresolver=${TRAEFIK_CERTRESOLVER}"
      - "traefik.http.services.${TRAEFIK_ROUTER}.loadbalancer.server.port=8081"
    networks:
      - traefik
    restart: unless-stopped

  businessbot:
    image: semorgana/powerbot:latest
    env_file:
      - ./.env
    environment:
      DB_PATH: /data/state.db
      APP_ENTRYPOINT: business_main.py
    volumes:
      - ./:/data
    networks:
      - traefik
    restart: on-failure
    profiles: ["business"]

  migrate:
    image: semorgana/powerbot-migrate:latest
    env_file:
      - ./.env
    environment:
      TARGET_DB: /data/state.db
      SCHEMA_PATH: /app/schema.sql
    volumes:
      - ./:/data
    profiles: ["migrate"]

networks:
  traefik:
    external: true
